<script>
  export let fields;
  export let record;
  export let emptyRecord;
  export let rest_resource;
  export let records = [];
  $: title = `${!!record._id ? "Update" : "Add new"} ${rest_resource}`

  import Input from "./input.svelte";
  import "bootstrap/dist/css/bootstrap.min.css";

  async function handleSubmit() {
    const method = !!record._id ? "PATCH" : "POST";
    const url = !!record._id ? `${rest_resource}/${record._id}.json` : `${rest_resource}.json`;
    const response = await fetch(url, {
      method,
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(record)
    });
    if (response.ok) {
      const result = await response.json();
      if(method == "POST") {
        record._id = result.insertedId;
        records = records.concat(record);
      } else {
        records = records
      }
      record = { ...emptyRecord };
    }
  }
  function handleReset() {
    record = { ...emptyRecord };
  }
</script>

<h2>{title}</h2>
<form on:submit|preventDefault={handleSubmit} on:reset={handleReset}>
  <slot name="before-fields">
    <!-- optional fallback -->
  </slot>
  <slot name="fields">
    {#each fields as field}
      <Input {field} bind:value={record[field.key]} required={field.required} />
    {/each}
  </slot>
  <slot name="after-fields">
    <!-- optional fallback -->
  </slot>
  <slot name="buttons">
    <button type="submit" class="btn btn-primary">Submit</button>
    <button type="reset" class="btn btn-secondary">Cancel</button>
  </slot>
</form>